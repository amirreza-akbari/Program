package com.example.healthcheckapp;

import android.content.Intent;
import android.print.PrintAttributes;
import android.os.Bundle;
import android.print.PrintDocumentAdapter;
import android.print.PrintManager;
import android.widget.Button;
import android.widget.TextView;
import androidx.appcompat.app.AppCompatActivity;
import com.example.healthcheckapp.utils.LocaleManager;
import com.example.healthcheckapp.utils.ThemeManager;
import androidx.cardview.widget.CardView;
import android.graphics.Color;

public class ResultActivity extends AppCompatActivity {

    private TextView tvResult;
    private Button btnBackToMain, btnExit, btnPrint;
    private static String lastLanguage = null;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        // Ø§Ø¨ØªØ¯Ø§ ØªÙ… (Ø¸Ø§Ù‡Ø±) Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† Ø¨Ø± Ø§Ø³Ø§Ø³ Ø­Ø§Ù„Øª ØªÛŒØ±Ù‡ ÛŒØ§ Ø±ÙˆØ´Ù† ØªÙ†Ø¸ÛŒÙ… Ù…ÛŒâ€ŒØ´ÙˆØ¯
        if (ThemeManager.isDarkMode(this)) {
            setTheme(R.style.Theme_MyApp_Dark);  // Ø§Ú¯Ø± Ø­Ø§Ù„Øª ØªÛŒØ±Ù‡ Ø§Ø³ØªØŒ ØªÙ… ØªÛŒØ±Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ù…ÛŒâ€ŒØ´ÙˆØ¯
        } else {
            setTheme(R.style.Theme_MyApp_Light);  // Ø§Ú¯Ø± Ø­Ø§Ù„Øª Ø±ÙˆØ´Ù† Ø§Ø³ØªØŒ ØªÙ… Ø±ÙˆØ´Ù† Ø§Ù†ØªØ®Ø§Ø¨ Ù…ÛŒâ€ŒØ´ÙˆØ¯
        }

        // Ø¨Ø±Ø±Ø³ÛŒ Ø²Ø¨Ø§Ù† ÙØ¹Ù„ÛŒ Ùˆ ØªÙ†Ø¸ÛŒÙ… Ø²Ø¨Ø§Ù† Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù†
        String currentLang = LocaleManager.getLanguage(this);
        if (lastLanguage == null) {
            lastLanguage = currentLang;  // Ø¯Ø± ØµÙˆØ±ØªÛŒ Ú©Ù‡ Ø²Ø¨Ø§Ù† Ù‚Ø¨Ù„ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ù†Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯ØŒ Ø²Ø¨Ø§Ù† ÙØ¹Ù„ÛŒ Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
        }
        LocaleManager.setLocale(this, currentLang);  // Ø²Ø¨Ø§Ù† Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† Ø±Ø§ Ø¨Ø§ ØªÙˆØ¬Ù‡ Ø¨Ù‡ Ø²Ø¨Ø§Ù† ÙØ¹Ù„ÛŒ ØªÙ†Ø¸ÛŒÙ… Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…

        // Ù¾Ù†Ù‡Ø§Ù† Ú©Ø±Ø¯Ù† ActionBar Ø¨Ø±Ø§ÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ø¸Ø§Ù‡Ø±ÛŒ ØªÙ…ÛŒØ²ØªØ±
        if (getSupportActionBar() != null) {
            getSupportActionBar().hide();
        }

        // Ø§ÛŒØ¬Ø§Ø¯ UI Ø¨Ø¹Ø¯ Ø§Ø² Ø§Ø¬Ø±Ø§ÛŒ setLocale
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_result);  // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ layout ØµÙØ­Ù‡ Ù†ØªØ§ÛŒØ¬

        // Ú¯Ø±ÙØªÙ† CardView Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªØ§ÛŒÙ„â€ŒØ¯Ù‡ÛŒ
        CardView cardView = findViewById(R.id.cardView);

        // ØªÙ†Ø¸ÛŒÙ… Ø±Ù†Ú¯ Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ CardView Ø¨Ø§ ØªÙˆØ¬Ù‡ Ø¨Ù‡ ØªÙ… (Ø­Ø§Ù„Øª ØªÛŒØ±Ù‡ ÛŒØ§ Ø±ÙˆØ´Ù†)
        if (ThemeManager.isDarkMode(this)) {
            cardView.setCardBackgroundColor(Color.parseColor("#0f4b6f"));  // Ø±Ù†Ú¯ Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ Ø¢Ø¨ÛŒ ØªÛŒØ±Ù‡ Ø¯Ø± Ø­Ø§Ù„Øª ØªÛŒØ±Ù‡
        } else {
            cardView.setCardBackgroundColor(Color.parseColor("#FFFFFF"));  // Ø±Ù†Ú¯ Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ Ø³ÙÛŒØ¯ Ø¯Ø± Ø­Ø§Ù„Øª Ø±ÙˆØ´Ù†
        }

        // Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø¨Ù‡ Ú©Ø§Ù…Ù¾ÙˆÙ†Ù†Øªâ€ŒÙ‡Ø§ÛŒ UI
        tvResult = findViewById(R.id.tvResult);
        btnBackToMain = findViewById(R.id.btnBackToMain);
        btnExit = findViewById(R.id.btnExit);
        btnPrint = findViewById(R.id.btnPrint);  // Ø¯Ú©Ù…Ù‡ Ú†Ø§Ù¾

        // Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø§Ø² Intent
        String name = getIntent().getStringExtra("name");
        String surname = getIntent().getStringExtra("surname");
        String email = getIntent().getStringExtra("email");
        int score = getIntent().getIntExtra("totalScore", 0);  // Ø§Ù…ØªÛŒØ§Ø² Ú©Ø§Ø±Ø¨Ø±

        // ØªØ¹ÛŒÛŒÙ† ÙˆØ¶Ø¹ÛŒØª Ù¾ÛŒØ§Ù… Ø¨Ø±Ø§Ø³Ø§Ø³ Ø§Ù…ØªÛŒØ§Ø² Ùˆ Ø²Ø¨Ø§Ù†
        String status;
        if (score < 10) {
            status = currentLang.equals("fa") ? "âš ï¸ ÙˆØ¶Ø¹ÛŒØª: Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ù…Ø§ Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¨Ù‡Ø¨ÙˆØ¯ Ø¯Ø§Ø±Ø¯." : "âš ï¸ Status: Your information needs improvement.";
        } else if (score <= 15) {
            status = currentLang.equals("fa") ? "âœ… ÙˆØ¶Ø¹ÛŒØª: Ø®ÙˆØ¨ØŒ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¨Ù‡ØªØ± Ø´ÙˆÛŒØ¯." : "âœ… Status: Good, but you can improve.";
        } else if (score < 20) {
            status = currentLang.equals("fa") ? "ğŸŒŸ ÙˆØ¶Ø¹ÛŒØª: Ø®ÛŒÙ„ÛŒ Ø®ÙˆØ¨ØŒ Ø¹Ø§Ù„ÛŒ Ù¾ÛŒØ´ Ù…ÛŒâ€ŒØ±ÙˆÛŒØ¯!" : "ğŸŒŸ Status: Very good, you're doing great!";
        } else {
            status = currentLang.equals("fa") ? "ğŸ† ÙˆØ¶Ø¹ÛŒØª: Ù…Ù…ØªØ§Ø²ØŒ ÙÙˆÙ‚â€ŒØ§Ù„Ø¹Ø§Ø¯Ù‡â€ŒØ§ÛŒØ¯!" : "ğŸ† Status: Excellent, you are outstanding!";
        }

        // ÙØ±Ù…Øªâ€ŒØ¨Ù†Ø¯ÛŒ Ù…ØªÙ† Ù†ØªÛŒØ¬Ù‡ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø²Ø¨Ø§Ù†
        String result = (currentLang.equals("fa") ? 
                "Ù†Ø§Ù…: " + name + "\n\n" + 
                "Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ: " + surname + "\n\n" +
                "Ø§ÛŒÙ…ÛŒÙ„: " + email + "\n\n" +
                "Ù†Ù…Ø±Ù‡: " + score + "\n\n" + status :
                "Name: " + name + "\n\n" + 
                "Surname: " + surname + "\n\n" +
                "Email: " + email + "\n\n" +
                "Score: " + score + "\n\n" + status);

        // ØªÙ†Ø¸ÛŒÙ… Ù…ØªÙ† Ù†ØªÛŒØ¬Ù‡ Ø¯Ø± TextView
        tvResult.setText(result);

        // ØªÙ†Ø¸ÛŒÙ… Ù…ØªÙ† Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ Ø¨Ø±Ø§Ø³Ø§Ø³ Ø²Ø¨Ø§Ù† ÙØ¹Ù„ÛŒ
        btnBackToMain.setText(currentLang.equals("fa") ? "Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ" : "Back to Main");
        btnExit.setText(currentLang.equals("fa") ? "Ø®Ø±ÙˆØ¬" : "Exit");
        btnPrint.setText(currentLang.equals("fa") ? "Ú†Ø§Ù¾ Ù†ØªÛŒØ¬Ù‡" : "Print Result");

        // ØªÙ†Ø¸ÛŒÙ… Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø¯Ú©Ù…Ù‡ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ
        btnBackToMain.setOnClickListener(v -> {
            Intent intent = new Intent(ResultActivity.this, TopScoresActivity.class);
            startActivity(intent);
            finish();
        });

        // ØªÙ†Ø¸ÛŒÙ… Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø¯Ú©Ù…Ù‡ Ø®Ø±ÙˆØ¬
        btnExit.setOnClickListener(v -> finishAffinity());

        // ØªÙ†Ø¸ÛŒÙ… Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø¯Ú©Ù…Ù‡ Ú†Ø§Ù¾
        btnPrint.setOnClickListener(v -> printResult());
    }

    // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ú†Ø§Ù¾ Ù†ØªÛŒØ¬Ù‡
    private void printResult() {
        PrintManager printManager = (PrintManager) getSystemService(PRINT_SERVICE);
        if (printManager != null) {
            // Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ø§Ø² ÛŒÚ© Ú†Ø§Ù¾Ú¯Ø± Ù…Ø³ØªÙ†Ø¯ Ø¨Ø±Ø§ÛŒ Ú†Ø§Ù¾ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
            PrintDocumentAdapter printAdapter = new PrintDocumentAdapter();
            printAdapter.printDocument(this, findViewById(R.id.tvResult));  // Ú†Ø§Ù¾ Ù…ØªÙ† Ù…ÙˆØ¬ÙˆØ¯ Ø¯Ø± TextView
        }
    }

    // Ø¨Ø§Ø²Ø³Ø§Ø²ÛŒ Activity Ø¯Ø± ØµÙˆØ±ØªÛŒ Ú©Ù‡ Ø²Ø¨Ø§Ù† ØªØºÛŒÛŒØ± Ú©Ø±Ø¯Ù‡ Ø¨Ø§Ø´Ø¯
    @Override
    protected void onResume() {
        super.onResume();
        String currentLang = LocaleManager.getLanguage(this);
        if (!currentLang.equals(lastLanguage)) {
            lastLanguage = currentLang;
            recreate();  // ØµÙØ­Ù‡ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø³Ø§Ø®ØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
        }
    }
}
